# DigitalOcean App Platform Specification - Fixed for Session Issues
# Update existing app with: doctl apps update b2c2085f-d938-428c-9299-1165af8dfc3c --spec .do/app-fixed.yaml

name: clinicconnect-2
region: lon

# ============================================
# Services
# ============================================
services:
  - name: web
    # Build from Dockerfile
    dockerfile_path: Dockerfile.optimized
    
    # GitHub repository
    github:
      repo: lacson1/clinicconnect-2
      branch: main
      deploy_on_push: true
    
    # Instance configuration
    instance_count: 1
    instance_size_slug: basic-xxs  # $5/mo, upgrade as needed
    
    # HTTP settings
    http_port: 5001
    
    # Health check
    health_check:
      http_path: /api/health
      initial_delay_seconds: 90  # Increased to allow for migrations
      period_seconds: 30
      timeout_seconds: 10
      success_threshold: 1
      failure_threshold: 5
    
    # Environment variables
    envs:
      - key: NODE_ENV
        value: production
        scope: RUN_TIME
      - key: PORT
        value: "5001"
        scope: RUN_TIME
      - key: DATABASE_URL
        scope: RUN_TIME
        value: ${db.DATABASE_URL}
        type: SECRET
      # CRITICAL: These must be set as app-level environment variables in DigitalOcean dashboard
      # Go to: Settings â†’ App-Level Environment Variables
      # Set these as SECRET type (not plain text):
      # - JWT_SECRET: Use the value from DEPLOYMENT_ERRORS_FIXED.md
      # - SESSION_SECRET: Use the value from DEPLOYMENT_ERRORS_FIXED.md
      - key: JWT_SECRET
        scope: RUN_TIME
        type: SECRET
        value: ${JWT_SECRET}  # Must be set in dashboard
      - key: SESSION_SECRET
        scope: RUN_TIME
        type: SECRET
        value: ${SESSION_SECRET}  # Must be set in dashboard - REQUIRED for production
      - key: SESSION_COOKIE_MAX_AGE
        value: "2592000000"
        scope: RUN_TIME
      # Optional: Set ALLOWED_ORIGINS to your app URL once deployed
      # Will be set automatically after first deployment
      - key: ALLOWED_ORIGINS
        value: ""  # Will be updated after deployment with actual URL
        scope: RUN_TIME
    
    # Routes - this enables public access
    routes:
      - path: /

# ============================================
# Database (matches existing)
# ============================================
databases:
  - name: db
    engine: PG
    version: "16"
    size: db-s-dev-database  # Free dev database

# ============================================
# Alerts
# ============================================
alerts:
  - rule: DEPLOYMENT_FAILED
  - rule: DOMAIN_FAILED

